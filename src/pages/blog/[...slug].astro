---
import { getCollection } from 'astro:content';
import BlogPost from '../../layouts/BlogPost.astro';
import readingTime from 'reading-time'; // Thêm import này nếu chưa có

export async function getStaticPaths() {
  const blogEntries = await getCollection('blog');
  
  // Sort entries by date for better next/prev navigation
  const sortedEntries = [...blogEntries].sort(
    (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
  );
  
  return sortedEntries.map((entry, index) => {
    // Calculate readingTime from markdown content
    const readingTimeResult = readingTime(entry.body);
    
    // Format reading time into readable string
    let readingTimeStr;
    if (readingTimeResult.minutes < 1) {
      readingTimeStr = 'Under 1 min read';
    } else {
      // Round up and format as "X min read"
      const minutes = Math.ceil(readingTimeResult.minutes);
      readingTimeStr = `${minutes} min read`;
    }
    
    return {
      params: { slug: entry.slug },
      props: { 
        entry,
        readingTimeValue: readingTimeStr, // Pass formatted string
        readingTimeStats: readingTimeResult, // Pass complete statistics
        nextPost: index > 0 ? sortedEntries[index - 1] : null,
        prevPost: index < sortedEntries.length - 1 ? sortedEntries[index + 1] : null
      },
    };
  });
}

const { entry, nextPost, prevPost, readingTimeValue, readingTimeStats } = Astro.props;
const { Content } = await entry.render();

// Override readingTime from frontmatter if available, otherwise use calculated value
const finalReadingTime = entry.data.readingTime || readingTimeValue;
---


<BlogPost {...entry.data} readingTime={finalReadingTime}>
    <!-- Main Content - Enhanced with better typography and spacing -->
    <div class="prose prose-zinc dark:prose-invert max-w-none prose-headings:scroll-mt-24 prose-headings:font-semibold prose-a:text-zinc-800 dark:prose-a:text-zinc-300 prose-a:font-medium prose-a:underline-offset-4 hover:prose-a:text-zinc-600 dark:hover:prose-a:text-zinc-100 prose-img:rounded-xl sm:prose-base prose-sm">
      <Content />
    </div>
</BlogPost>

<script>
  // Add copy buttons to code blocks
  function initializeCodeCopyButtons() {
    const codeBlocks = document.querySelectorAll('pre');
    
    codeBlocks.forEach(block => {
      // Skip if already processed by either method
      if (block.classList.contains('code-block-processed') || block.classList.contains('enhanced')) {
        return;
      }
      
      block.classList.add('code-block-processed');
      
      // Create wrapper if not already wrapped
      let wrapper;
      if (block.parentNode.classList.contains('relative') && block.parentNode.classList.contains('group')) {
        wrapper = block.parentNode;
      } else {
        wrapper = document.createElement('div');
        wrapper.className = 'relative group';
        block.parentNode.insertBefore(wrapper, block);
        wrapper.appendChild(block);
      }
      
      // Add copy button if not already present
      if (!wrapper.querySelector('.copy-button') && !wrapper.querySelector('.copy-code-button')) {
        const copyButton = document.createElement('button');
        copyButton.className = 'copy-button absolute top-2 right-2 p-1.5 rounded-md bg-zinc-700/50 hover:bg-zinc-700 text-zinc-200 opacity-0 group-hover:opacity-100 transition-opacity duration-200';
        copyButton.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75" />
          </svg>
        `;
        
        copyButton.addEventListener('click', () => {
          const code = block.querySelector('code').innerText;
          navigator.clipboard.writeText(code);
          
          // Show copied feedback
          copyButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
            </svg>
          `;
          
          setTimeout(() => {
            copyButton.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75" />
              </svg>
            `;
          }, 2000);
        });
        
        wrapper.appendChild(copyButton);
      }
    });
  }
  
  // Blog post specific initialization - let Layout handle SPA transitions
  function initializeBlogPost() {
    // Initialize code copy buttons
    initializeCodeCopyButtons();
    
    // Ensure content visibility
    const mainContent = document.querySelector('main');
    if (mainContent) {
      mainContent.style.opacity = '1';
      mainContent.style.transform = 'translateY(0)';
      mainContent.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
    }
    
    // Scroll to hash if present in URL
    if (window.location.hash) {
      setTimeout(() => {
        const element = document.querySelector(window.location.hash);
        if (element) {
          element.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }, 100);
    }
  }
  
  // Initialize on first load
  document.addEventListener('DOMContentLoaded', initializeBlogPost);
  
  // Re-initialize when content changes via Astro's view transitions
  document.addEventListener('astro:page-load', initializeBlogPost);
  
  // For compatibility with custom transition system
  document.addEventListener('page-transition-complete', initializeBlogPost);
</script>

<style>
  /* Language badge styling */
  .language-badge {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    text-transform: lowercase;
    letter-spacing: 0.05em;
  }
  
  /* Extra small screens */
  @media (min-width: 480px) {
    .xs\:inline {
      display: inline;
    }
    
    .xs\:hidden {
      display: none;
    }
  }
  
  /* Enhanced typography for blog content - Responsive adjustments */
  .prose {
    @apply text-zinc-800 dark:text-zinc-200;
  }
  
  .prose h1, .prose h2, .prose h3, .prose h4 {
    @apply text-zinc-900 dark:text-zinc-100 font-semibold;
  }
  
  .prose h1 {
    @apply text-2xl sm:text-3xl md:text-4xl;
  }
  
  .prose h2 {
    @apply text-xl sm:text-2xl mt-8 sm:mt-12 mb-3 sm:mb-4 pb-2 border-b border-zinc-200 dark:border-zinc-800;
  }
  
  .prose h3 {
    @apply text-lg sm:text-xl mt-6 sm:mt-8 mb-2 sm:mb-3;
  }
  
  .prose p {
    @apply leading-relaxed mb-4 sm:mb-6 text-sm sm:text-base;
  }
  
  .prose a {
    @apply text-zinc-800 dark:text-zinc-300 font-medium underline decoration-zinc-400 dark:decoration-zinc-600 underline-offset-2 hover:text-zinc-600 dark:hover:text-zinc-100 hover:decoration-zinc-600 dark:hover:decoration-zinc-400 transition-colors;
  }
  
  .prose blockquote {
    @apply border-l-4 border-zinc-300 dark:border-zinc-700 pl-4 italic text-zinc-700 dark:text-zinc-300 my-4 sm:my-6;
  }
    
  .prose code {
    @apply bg-zinc-100 dark:bg-zinc-800 px-1.5 py-0.5 rounded text-zinc-800 dark:text-zinc-200 text-sm font-medium;
  }
  
  .prose pre {
    @apply bg-[#1e293b] dark:bg-[#1e293b] text-zinc-200 p-3 sm:p-4 rounded-lg overflow-x-auto text-xs sm:text-sm my-4 sm:my-6 shadow-md !important;
  }
  
  .prose pre code {
    @apply bg-transparent p-0 text-zinc-200 dark:text-zinc-200 !important;
  }
  
  .prose img {
    @apply rounded-lg shadow-md my-6 sm:my-8 mx-auto max-w-full h-auto;
  }
  
  .prose ul, .prose ol {
    @apply my-4 sm:my-6 pl-5 sm:pl-6;
  }
  
  .prose li {
    @apply mb-1 sm:mb-2 text-sm sm:text-base;
  }
  
  .prose hr {
    @apply my-8 sm:my-10 border-zinc-200 dark:border-zinc-800;
  }
  
  /* Line clamp for truncating text */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>